# https://docs.github.com/en/actions/guides/building-and-testing-nodejs

name: Node.js CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  schedule:
    - cron:  '17 14 * * *'

env:
  MAIL_ADDR: ${{ secrets.MAIL_ADDR }}
  MAIL_PASSWORD: ${{ secrets.MAIL_PASSWORD }}
  MAIL_TO: ${{ secrets.MAIL_TO }}

jobs:
  build:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        # Each version of Node.js specified in the node-version array creates a job that runs the same steps.
        node-version: [16.x]

    steps:
      - uses: actions/checkout@v2
      - name: Use Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v2
        with:
          node-version: ${{ matrix.node-version }}
      - run: node --version && npm --version
      - run: npm ci
      - run: npm run build
      - run: npm test

  check-package-lock:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        # Each version of Node.js specified in the node-version array creates a job that runs the same steps.
        node-version: [16.x]

    steps:
      - uses: actions/checkout@v2
      - name: Use Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v2
        with:
          node-version: ${{ matrix.node-version }}
      - run: node --version && npm --version
      - run: npm install
      - name: Fail if npm install changed package-lock.json
        run: git diff --exit-code package-lock.json
  
  send-email:
    needs: [build, check-package-lock]
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v2
      - name: Send mail
        uses: dawidd6/action-send-mail@v3.7.1
        with:
          server_address: smtp.gmail.com
          server_port: 465
          username: ${{ secrets.MAIL_ADDR }}
          from: ${{ secrets.MAIL_ADDR }}
          password: ${{ secrets.MAIL_PASSWORD }}
          subject: BUILD status of ${{ github.repository }} has ${{ github.jobs.build.result }}
          body: BUILD job in worflow ${{ github.workflow }} of ${{ github.repository }} has ${{ needs.build.result }}
          to: ${{ secrets.MAIL_TO }}
