{"ast":null,"code":"import { useCallback, useEffect, useRef, useState } from 'react';\n\n/**\n * Buffer of data with delay.\n * Data are in the format of array of string.\n *\n * Provides a way to delay inputted data before they are used.\n * Data can be preprocessed by preprocessor function, which processes inputted lines as programmer wishes.\n *\n * To add new lines, use addLines function. After that, they will be preprocessed with preprocessor function.\n * Each added group of lines is treated as a batch and outputted together.\n * Buffer periodically (with delay) checks if any new lines were added, and if so, it will add oldest batch of lines not yet ouputted.\n * Then, after delay, next batch will be outputted (if any), etc.\n *\n * @param delay - delay after which buffer outputs new data (if any)\n * @param preprocessor - function by which each added line is modified\n */\nexport const useDataBuffer = function (delay) {\n  let preprocessor = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : lines => lines;\n  // input to the buffer\n  const [dataIn, setDataIn] = useState([]); // output from the buffer\n\n  const [dataOut, setDataOut] = useState([]); // number of lines till now outputted\n\n  const [currentLineCount, setCurrentLineCount] = useState(0); // lengths of batches of new lines (added with addLines)\n\n  const newLinesCounts = useRef([]);\n  const bufferInterval = useRef();\n  useEffect(() => {\n    bufferInterval.current = setInterval(() => {\n      if (newLinesCounts.current.length) {\n        setCurrentLineCount(currentLineCount => currentLineCount + newLinesCounts.current[0]);\n        newLinesCounts.current.shift();\n      }\n    }, delay);\n  }, [delay]);\n  useEffect(() => {\n    setDataOut(dataIn.slice(0, currentLineCount)); // this code has to execute only when currentLineCount changes\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, [currentLineCount]); // adds new lines to the buffer\n\n  const addLines = useCallback(lines => {\n    setDataIn(dataIn => [...dataIn, ...preprocessor(lines)]);\n    newLinesCounts.current.push(lines.length);\n  }, [preprocessor]);\n  return [dataOut, addLines];\n};","map":{"version":3,"names":["useCallback","useEffect","useRef","useState","useDataBuffer","delay","preprocessor","lines","dataIn","setDataIn","dataOut","setDataOut","currentLineCount","setCurrentLineCount","newLinesCounts","bufferInterval","current","setInterval","length","shift","slice","addLines","push"],"sources":["/home/pkorytar/Projects/RedHat/pnc-web-ui-react/src/containers/useDataBuffer.ts"],"sourcesContent":["import { MutableRefObject, useCallback, useEffect, useRef, useState } from 'react';\n\ntype PreprocessorFunction = (lines: string[]) => string[];\ntype AddLinesFunction = (lines: string[]) => void;\n/**\n * Buffer of data with delay.\n * Data are in the format of array of string.\n *\n * Provides a way to delay inputted data before they are used.\n * Data can be preprocessed by preprocessor function, which processes inputted lines as programmer wishes.\n *\n * To add new lines, use addLines function. After that, they will be preprocessed with preprocessor function.\n * Each added group of lines is treated as a batch and outputted together.\n * Buffer periodically (with delay) checks if any new lines were added, and if so, it will add oldest batch of lines not yet ouputted.\n * Then, after delay, next batch will be outputted (if any), etc.\n *\n * @param delay - delay after which buffer outputs new data (if any)\n * @param preprocessor - function by which each added line is modified\n */\nexport const useDataBuffer = (\n  delay: number,\n  preprocessor: PreprocessorFunction = (lines: string[]) => lines\n): [string[], AddLinesFunction] => {\n  // input to the buffer\n  const [dataIn, setDataIn] = useState<string[]>([]);\n  // output from the buffer\n  const [dataOut, setDataOut] = useState<string[]>([]);\n  // number of lines till now outputted\n  const [currentLineCount, setCurrentLineCount] = useState<number>(0);\n  // lengths of batches of new lines (added with addLines)\n  const newLinesCounts = useRef<number[]>([]);\n\n  const bufferInterval: MutableRefObject<NodeJS.Timer | undefined> = useRef();\n\n  useEffect(() => {\n    bufferInterval.current = setInterval(() => {\n      if (newLinesCounts.current.length) {\n        setCurrentLineCount((currentLineCount) => currentLineCount + newLinesCounts.current[0]);\n        newLinesCounts.current.shift();\n      }\n    }, delay);\n  }, [delay]);\n\n  useEffect(() => {\n    setDataOut(dataIn.slice(0, currentLineCount));\n    // this code has to execute only when currentLineCount changes\n    // eslint-disable-next-line react-hooks/exhaustive-deps\n  }, [currentLineCount]);\n\n  // adds new lines to the buffer\n  const addLines = useCallback(\n    (lines: string[]) => {\n      setDataIn((dataIn) => [...dataIn, ...preprocessor(lines)]);\n      newLinesCounts.current.push(lines.length);\n    },\n    [preprocessor]\n  );\n\n  return [dataOut, addLines];\n};\n"],"mappings":"AAAA,SAA2BA,WAA3B,EAAwCC,SAAxC,EAAmDC,MAAnD,EAA2DC,QAA3D,QAA2E,OAA3E;;AAIA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,OAAO,MAAMC,aAAa,GAAG,UAC3BC,KAD2B,EAGM;EAAA,IADjCC,YACiC,uEADKC,KAAD,IAAqBA,KACzB;EACjC;EACA,MAAM,CAACC,MAAD,EAASC,SAAT,IAAsBN,QAAQ,CAAW,EAAX,CAApC,CAFiC,CAGjC;;EACA,MAAM,CAACO,OAAD,EAAUC,UAAV,IAAwBR,QAAQ,CAAW,EAAX,CAAtC,CAJiC,CAKjC;;EACA,MAAM,CAACS,gBAAD,EAAmBC,mBAAnB,IAA0CV,QAAQ,CAAS,CAAT,CAAxD,CANiC,CAOjC;;EACA,MAAMW,cAAc,GAAGZ,MAAM,CAAW,EAAX,CAA7B;EAEA,MAAMa,cAA0D,GAAGb,MAAM,EAAzE;EAEAD,SAAS,CAAC,MAAM;IACdc,cAAc,CAACC,OAAf,GAAyBC,WAAW,CAAC,MAAM;MACzC,IAAIH,cAAc,CAACE,OAAf,CAAuBE,MAA3B,EAAmC;QACjCL,mBAAmB,CAAED,gBAAD,IAAsBA,gBAAgB,GAAGE,cAAc,CAACE,OAAf,CAAuB,CAAvB,CAA1C,CAAnB;QACAF,cAAc,CAACE,OAAf,CAAuBG,KAAvB;MACD;IACF,CALmC,EAKjCd,KALiC,CAApC;EAMD,CAPQ,EAON,CAACA,KAAD,CAPM,CAAT;EASAJ,SAAS,CAAC,MAAM;IACdU,UAAU,CAACH,MAAM,CAACY,KAAP,CAAa,CAAb,EAAgBR,gBAAhB,CAAD,CAAV,CADc,CAEd;IACA;EACD,CAJQ,EAIN,CAACA,gBAAD,CAJM,CAAT,CArBiC,CA2BjC;;EACA,MAAMS,QAAQ,GAAGrB,WAAW,CACzBO,KAAD,IAAqB;IACnBE,SAAS,CAAED,MAAD,IAAY,CAAC,GAAGA,MAAJ,EAAY,GAAGF,YAAY,CAACC,KAAD,CAA3B,CAAb,CAAT;IACAO,cAAc,CAACE,OAAf,CAAuBM,IAAvB,CAA4Bf,KAAK,CAACW,MAAlC;EACD,CAJyB,EAK1B,CAACZ,YAAD,CAL0B,CAA5B;EAQA,OAAO,CAACI,OAAD,EAAUW,QAAV,CAAP;AACD,CAxCM"},"metadata":{},"sourceType":"module"}